function number_format(number, decimals, dec_point, thousands_sep) {
    number = (number + '').replace(/[^0-9+\-Ee.]/g, '');
    var n = !isFinite(+number) ? 0 : +number,
        prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
        sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
        dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
        s = '',
        toFixedFix = function (n, prec) {
            var k = Math.pow(10, prec);
            return '' + Math.round(n * k) / k;
        };
    s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.');
    if (s[0].length > 3) {
        s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
    }
    if ((s[1] || '').length < prec) {
        s[1] = s[1] || '';
        s[1] += new Array(prec - s[1].length + 1).join('0');
    }
    return s.join(dec);
}

$(function () {

    // Modal Cart Items

    $('#items-qty').on("cut copy paste", function (e) {
        e.preventDefault();
    });

    $('#items-qty-minus').on('click', function () {
        var qty = parseInt($('#items-qty').val());

        if (qty <= 1 && $(this).prop('disabled') == false) {
            $(this).prop('disabled', true);
        } else {
            $(this).prop('disabled', false);
            $('#items-qty').val(qty - 1).keyup();
            if (parseInt($('#items-qty').val()) <= 1) {
                $(this).prop('disabled', true);
            }
        }
    })

    $('#items-qty-plus').on('click', function () {
        var qty = parseInt($(this).parents('.qty').find('input').val());
        if ((qty + 1).toString().length <= parseInt($(this).parents('.qty').find('input').prop('maxlength'))) {
            $('#items-qty').val(qty + 1).keyup();
        }
        $('#items-qty-minus').prop('disabled', false);
    })


    $('body').on('click', '.btn-qty-minus', function () {

        var qty = parseInt($(this).parents('.qty').find('input').val());
        if (qty <= 1 && $(this).prop('disabled') == false) {
            $(this).prop('disabled', true);
        } else {
            $(this).prop('disabled', false);
            $(this).parents('.qty').find('input').val(qty - 1);
            if (parseInt($(this).closest('input').val()) <= 1) {
                $(this).prop('disabled', true);
            }
        }

        var item_key = $(this).parents('.cart-list-product').attr('data-item-key');
        var item_id = $(this).parents('.cart-list-product').attr('data-item-id');
        var item = $(this).parents('.cart-list-product');

        $.post(root_url + "Cart/ItemQty", { item_key: item_key, item_id: item_id, item_qty: $(this).parents('.qty').find('input').val() })
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        $('#subtotal-cart').text(result.subtotal_cart);
                        if(result.total_discount_cart != 0){
                            $('#total-cart').text(result.total_discount_cart);
                        }else{
                            $('#total-cart').text(result.total_cart);
                        }
                        if(result.discount_item != undefined){
                            item.find('#discount-item').text(result.discount_item);
                            item.find('#total-item').text(result.total_item);
                        }else{
                            item.find('#total-item').text(result.total_item);
                        }
                    } else {
                        swal("Erreur !", result.info, "error");
                    }
                } catch (error) { swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
            }, "json");
    })

    $('body').on('click', '.btn-qty-plus', function () {
        var qty = parseInt($(this).parents('.qty').find('input').val());
        if ((qty + 1).toString().length <= parseInt($(this).parents('.qty').find('input').prop('maxlength'))) {
            $(this).parents('.qty').find('input').val(qty + 1).keyup();
        }
        $(this).parents('.qty').find('.btn-qty-minus').prop('disabled', false);


        var item_key = $(this).parents('.cart-list-product').attr('data-item-key');
        var item_id = $(this).parents('.cart-list-product').attr('data-item-id');
        var item = $(this).parents('.cart-list-product');

        $.post(root_url + "Cart/ItemQty", { item_key: item_key, item_id: item_id, item_qty: $(this).parents('.qty').find('input').val() })
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        $('#subtotal-cart').text(result.subtotal_cart);
                        if(result.total_discount_cart != 0){
                            $('#total-cart').text(result.total_discount_cart);
                        }else{
                            $('#total-cart').text(result.total_cart);
                        }
                        if(result.discount_item != undefined){
                            item.find('#discount-item').text(result.discount_item);
                            item.find('#total-item').text(result.total_item);
                        }else{
                            item.find('#total-item').text(result.total_item);
                        }
                    } else {
                        swal("Erreur !", result.info, "error");
                    }
                } catch (error) { swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
            }, "json");
    })


    /**
     * Launch modal for specific item to add it on cart.
     */
    $('.launch-item-modal').click(function () {
        // $('#bd-item-modal').modal("show");return false;
        var item_id = $(this).attr('data-item-id');

        $('#launch-item-modal-' + item_id).removeClass().addClass('fas fa-circle-notch fa-spin');
        $.post(base_url + "/Fetch", { item_id: item_id })
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        $('#item-modal-label').html('<i class="mdi mdi-food"></i> ' + $('#item-' + item_id + '-name').text());
                        $('#item-modal-content').html(result.info);

                        if (result.discountQty !== undefined) {
                            $('#discount-qty').attr('data-item-free-qty', result.discountQty.freeQty)
                            $('#discount-qty').attr('data-item-purchased-qty', result.discountQty.purchasedQty)
                        }

                        $('#add-cart-modal').attr("data-item-price", result.defaultPrice);
                        $('input[name="item-id"]').val(result.item);
                        $('#item-total-price').text(result.defaultPrice);

                        $('#bd-item-modal').modal("show");
                        $('#launch-item-modal-' + item_id).removeClass().addClass('mdi mdi-cart-outline');
                    }
                } catch (error) { location.reload(); }
            }, "json");

    });
    $('#bd-item-modal').on('hidden.bs.modal', function (e) {
        $('#items-qty').val('1');
        $('#item-comment').val('').change();
        $('#discount-qty').attr('data-item-free-qty', 0)
        $('#discount-qty').attr('data-item-purchased-qty', 0)
    })
    /**
     * 
     */
    $('.btn-bookmark').click(function (e) {
        e.preventDefault();

        var item_id = $(this).attr("data-item-id");
        var action = $(this).attr("data-action");
        var icon = $(this).find("i");
        var btn = $(this);
        if (action === 'Add') {
            icon.removeClass().addClass("text-danger mdi mdi-heart");
            $(this).attr("data-action", "Delete");
        } else {
            icon.removeClass().addClass("mdi mdi-heart");
            $(this).attr("data-action", "Add");
        }

        $.post( root_url + "user/bookmark/" + action, {item_id: item_id})
            .done(function( data ) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'failed') {
                        if (action === 'Add') {
                            icon.removeClass().addClass("mdi mdi-heart");
                            btn.attr("data-action", "Add");
                        } else {
                            icon.removeClass().addClass("text-danger mdi mdi-heart");
                            btn.attr("data-action", "Delete");
                        }
                        swal('Erreur!', 'Operation echoué, essayez à nouveau!', 'warning')
                    }
                } catch (error) { location.reload(); }
        });

    });

    $('#sort-price-asc').click(function (e) {
        e.preventDefault();
        $('#dropdown-filter').html($(this).text() + ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')
        $('#card-row .col-md-4').sort(function (a, b) {
            return parseInt($(a).find(".product-footer").attr('data-price')) > parseInt($(b).find(".product-footer").attr('data-price')) ? 1 : -1;
        }).appendTo("#card-row");
    })

    $('#sort-price-desc').click(function (e) {
        e.preventDefault();
        $('#dropdown-filter').html($(this).text() + ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')
        $('#card-row .col-md-4').sort(function (a, b) {
            return parseInt($(a).find(".product-footer").attr('data-price')) < parseInt($(b).find(".product-footer").attr('data-price')) ? 1 : -1;
        }).appendTo("#card-row");
    })

    function getCheckedExtras() {
        var price = 0;
        $("#item-modal-form input:checkbox:checked").each(function () {
            price += parseFloat($(this).attr('data-price')) // do your staff with each checkbox
        });
        return price;
    }
    function calcDiscountQty(qty, freeQTy, purchasedQty) {
        free_qty = parseInt(freeQTy);
        purchased_qty = parseInt(purchasedQty);
        totalQty = free_qty + purchased_qty;
        if (qty >= totalQty) {
            restQty = qty - totalQty;
            regular_qty = purchased_qty;
            while (restQty >= totalQty) {
                restQty -= totalQty;
                regular_qty += purchased_qty;
            }
            return restQty + regular_qty;
        }
        return qty;
    }
    function percentage(total, discount_amount) {
        return (total - (total * (discount_amount / 100)));
    }

    //==========================[ Changing Qty ]=========================//
    $("#item-modal-form").on('keyup', '#items-qty', function () {

        //==========================[ check The Qty ]=========================//
        if (parseInt($(this).val()) == 0 || $(this).val() == '' || typeof parseInt($(this).val()) != 'number') {
            $(this).val('1');
        }
        (parseInt($(this).val()) > 1) ? $('#items-qty-minus').prop('disabled', false) : $('#items-qty-minus').prop('disabled', true);

        //==========================[ calc The Qty NET ]=========================//
        var freeQtY = parseInt($("#discount-qty").attr('data-item-free-qty'));
        var purchasedQty = parseInt($("#discount-qty").attr('data-item-purchased-qty'));
        var regularQty = parseInt($(this).val());
        var dataPrice = parseFloat($("#add-cart-modal").attr('data-item-price'));
        var totalQty = 0;


        totalQty = (freeQtY != 0 && freeQtY !== false) ? calcDiscountQty(regularQty, freeQtY, purchasedQty) : regularQty;

        //==========================[ calc The Total ]=========================//
        var totalPrice = (totalQty * (parseFloat(dataPrice) + parseFloat(getCheckedExtras()))).toFixed(3);

        $('#item-total-price').text(number_format(totalPrice, 3));
        $("#add-cart-modal").attr('data-item-total-price', totalPrice);
        if (totalPrice > parseFloat($('item-modal-content').attr('data-max-cart')) || totalQty == 0) {
            $("#add-cart-modal").prop("disabled", true);
        }

    })

    //==========================[ Check Prices/Extras ]=========================//
    $("#item-modal-form").on('change', 'input:checkbox', function () {

        //==========================[ calc The Qty NET ]=========================//
        var freeQtY = parseInt($("#discount-qty").attr('data-item-free-qty'));
        var purchasedQty = parseInt($("#discount-qty").attr('data-item-purchased-qty'));
        var regularQty = parseInt($('#items-qty').val());
        var dataPrice = parseFloat($("#add-cart-modal").attr('data-item-price'));
        var totalQty = 0;
        // Check if there is Discount.

        totalQty = (freeQtY != 0 && freeQtY !== false) ? calcDiscountQty(regularQty, freeQtY, purchasedQty) : regularQty;

        //==========================[ calc The Total ]=========================//
        var totalPrice = (totalQty * (parseFloat(dataPrice) + parseFloat(getCheckedExtras()))).toFixed(3);

        $('#item-total-price').text(number_format(totalPrice, 3));
        $("#add-cart-modal").attr('data-item-total-price', totalPrice);
        if (totalPrice > parseFloat($('item-modal-content').attr('data-max-cart')) || totalQty == 0) {
            $("#add-cart-modal").prop("disabled", true);
        }
    });


    $("#item-modal-content").on('change', '#item-price-size-content :input:radio', function () {


        $("#add-cart-modal").attr('data-item-price', $(this).attr('data-price'))

        //==========================[ calc The Qty NET ]=========================//
        var freeQtY = parseInt($("#discount-qty").attr('data-item-free-qty'));
        var purchasedQty = parseInt($("#discount-qty").attr('data-item-purchased-qty'));
        var regularQty = parseInt($('#items-qty').val());
        var dataPrice = parseFloat($("#add-cart-modal").attr('data-item-price'));

        var totalQty = 0;
        // Check if there is Discount.

        totalQty = (freeQtY != 0 && freeQtY !== false) ? calcDiscountQty(regularQty, freeQtY, purchasedQty) : regularQty;

        //==========================[ calc The Total ]=========================//
        var totalPrice = (totalQty * (parseFloat(dataPrice) + parseFloat(getCheckedExtras()))).toFixed(3);

        $('#item-total-price').text(number_format(totalPrice, 3));
        $("#add-cart-modal").attr('data-item-total-price', totalPrice);
        if (totalPrice > parseFloat($('item-modal-content').attr('data-max-cart')) || totalQty == 0) {
            $("#add-cart-modal").prop("disabled", true);
        }
    });
    $('body').on('click', function (e) {
        $('[data-toggle="popover"]').each(function () {
            //the 'is' for buttons that trigger popups
            //the 'has' for icons within a button that triggers a popup
            if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                $(this).popover('hide');
            }
        });
    });

    //==========================[ Submit Item ]=========================//
    $('#item-modal-form').on('submit', function (e) {
        e.preventDefault();
        $('#add-cart-icon').removeClass().addClass('fas fa-circle-notch fa-spin');
        var cart_data = $(this).serialize();
        $.post(root_url + "Cart/AddItem", cart_data)
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        $.post(root_url + "Cart/Init", { init: true })
                        
                            .done(function (data) {
                                try {
                                    var result = JSON.parse(data);
                                    if (result.status == 'success') {
                                        $('.cart-sidebar-body').html(result.info.data);
                                        $('#cart-value, #items-cart').text(result.info.count_items);
                                        $('#subtotal-cart').text(result.info.subtotal_cart);
                                        if(result.info.total_discount_cart != 0){
                                            $('#total-cart').text(result.info.total_discount_cart);
                                        }else{
                                            $('#total-cart').text(result.info.total_cart);

                                        }
                                        $('[data-toggle="tooltip"]').tooltip({container:'.cart-sidebar-body', trigger: 'hover', placement:"top"});
                                        $('[data-toggle="popover"]').popover({container:'.cart-sidebar-body', trigger: 'hover click', placement:"top"});

                                        if($('#checkout-cart').is(':disabled')){
                                            $('#checkout-cart').prop('disabled', false);
                                            $('#btn-discount').prop('disabled', false);
                                        }

                                        $('#add-cart-icon').removeClass().addClass('mdi mdi-check-circle');
                                        setTimeout(function(){
                                            $('#add-cart-icon').removeClass().addClass('mdi mdi-cart');
                                        }, 2000);
                                        
                                    } else {
                                        swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error");
                                    }
                                } catch (error) { swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
                            }, "json");
                    }
                    if (result.status == 'failed') {
                        alert(result.info)
                        swal({
                            title: "Êtes-vous sûr?",
                            text: result.info,
                            icon: "info",
                            buttons: {
                                cancel: {
                                    text: "Annuler",
                                    value: null,
                                    visible: !0,
                                    className: "btn btn-default",
                                    closeModal: !0
                                },
                                confirm: {
                                    text: "Accepter",
                                    value: !0,
                                    visible: !0,
                                    className: "btn btn-success",
                                    closeModal: 0
                                }
                            }
                        })
                            .then((willDelete) => {
                                if (willDelete) {

                                    $.post(root_url + "Cart/AddItem", cart_data + '&reset-cart=' + true)
                                        .done(function (data) {
                                            try {
                                                var obj = jQuery.parseJSON(data);
                                                if (obj.status === 'success') {
                                                    $.post(root_url + "Cart/Init", { init: true })
                                                        .done(function (data) {
                                                            try {
                                                                var result = JSON.parse(data);
                                                                if (result.status == 'success') {
                                                                    $('.cart-sidebar-body').html(result.info.data);
                                                                    $('#cart-value, #items-cart').text(result.info.count_items);
                                                                    $('#subtotal-cart').text(result.info.subtotal_cart);
                                                                    if(result.info.total_discount_cart != 0){
                                                                        $('#total-cart').text(result.info.total_discount_cart);
                                                                    }else{
                                                                        $('#total-cart').text(result.info.total_cart);
                                                                    }
                                                                    $('#delivery-cart').text(result.info.delivery_fee);

                                                                    $('[data-toggle="tooltip"]').tooltip({container:'.cart-sidebar-body', trigger: 'hover', placement:"top"});
                                                                    $('[data-toggle="popover"]').popover({container:'.cart-sidebar-body', trigger: 'hover click', placement:"top"});
                                                                    $('#add-cart-icon').removeClass().addClass('mdi mdi-check-circle');
                                                                    setTimeout(function(){
                                                                        $('#add-cart-icon').removeClass().addClass('mdi mdi-cart');
                                                                    }, 2000);
                                                                } else {
                                                                    swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error");
                                                                }
                                                            } catch (error) { swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
                                                        }, "json");
                                                } else {
                                                    swal({
                                                        title: "Erreur!",
                                                        text: obj.info,
                                                        icon: "error",
                                                        closeOnEsc: false,
                                                        closeOnClickOutside: false
                                                    }).then(function (isConfirm) {
                                                        if (isConfirm) {
                                                            location.reload();
                                                        }
                                                    })
                                                }
                                            } catch (err) {
                                                swal({
                                                    title: "Erreur!",
                                                    text: "Operation echoué, essayez à nouveau!",
                                                    icon: "error",
                                                    closeOnEsc: false,
                                                    closeOnClickOutside: false
                                                }).then(function (isConfirm) {
                                                    if (isConfirm) {
                                                        location.reload();
                                                    }
                                                })
                                            }

                                        })
                                        .fail(function () {
                                            swal("Erreur!", "Operation echoué, essayez à nouveau!", {
                                                icon: "error",
                                            });
                                        });

                                }
                            });
                            $('#add-cart-icon').removeClass().addClass('mdi mdi-cart');

                    }
                } catch (error) { swal("Erreur!", "Operation echoué, essayez à nouveau!", 'error') }
            }, "json");
    });

    $('body').on('click', '.remove-cart-item', function (e) {
        // e.preventDefault();

        var item_key = $(this).parent().attr('data-item-key');
        var item_id = $(this).parent().attr('data-item-id');
        var item = $(this).parent();
        $('.tooltip').tooltip('hide');
        var rdf = 0;
        if($('#rdf-change').attr('data-rdf') != undefined){
            rdf = $('#rdf-change').attr('data-rdf');
        }
        $(this).prop('disabled', true);
        $.post(root_url + "Cart/RemoveItem", { item_key: item_key, item_id: item_id, rdf: rdf })
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        item.remove();
                        $('#subtotal-cart').text(result.subtotal_cart);
                        $('#total-cart').text(result.total_cart);
                        if(parseFloat(result.total_cart) == 0){
                            $('#checkout-cart').prop('disabled', true);
                            $('#btn-discount').prop('disabled', true);
                        }else{
                            $('#checkout-cart').prop('disabled', false);
                            $('#btn-discount').prop('disabled', false);
                        }
                        if(result.delivery_fee != 0){
                            $('#delivery-cart').text(result.delivery_fee);
                        }
                        $('#cart-value, #items-cart').text(result.count_items);

                    } else {
                        swal("Erreur !", result.info, "error");
                        $(this).prop('disabled', false);
                    }
                } catch (error) { $(this).prop('disabled', false);swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
            }, "json");
    })

    $('body').on('click', '#btn-discount', function (e) {
        e.preventDefault();

        $.post(root_url + "Cart/CartDiscount", { rid: $('#menu-rid').attr('data-rid'), promo_code: $('#promo-code').val() })
            .done(function (data) {
                try {
                    var result = JSON.parse(data);
                    if (result.status == 'success') {
                        $('#total-cart').text(result.total_item);

                    } else {
                        swal("Avertissement !", result.info, "warning");
                    }
                } catch (error) { swal("Erreur !", "Erreur survenue, veuillez réessayer!", "error"); }
            }, "json");
    })

    $('#checkout-cart').on('click', function (e) {
        e.preventDefault();
        if($(this).attr('data-toggle') == undefined){
            location.href = root_url + 'user/checkout';
        }else{
            $('#page-redirect').attr('data-redirect', root_url + 'user/checkout')
        }
    })
});